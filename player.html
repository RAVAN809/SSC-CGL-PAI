
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="videoTitle">Video Player</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 1.5em; color: #1E90FF; border-bottom: 2px solid #1E90FF; padding-bottom: 10px; margin-bottom: 15px; }
        .video-js { width: 100%; height: auto; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .controls label, .controls button { padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: background-color 0.2s; }
        .controls button { background-color: #dc3545; color: white; border: none; }
        .controls button:hover { background-color: #c82333; }
        .back-button { background-color: #6c757d; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; }
        .favorite-btn { background-color: #ffc107; color: #333; border: none; margin-left: 10px; }
        .favorite-btn:hover { background-color: #e0a800; }
        .speed-control { display: flex; align-items: center; }
        #speedSelect { padding: 7px; border-radius: 5px; border: 1px solid #ccc; margin-left: 5px; }
        .status { margin-top: 15px; font-weight: bold; color: #28a745; text-align: center;}
    </style>
</head>
<body>
    <div class="container">
        <h1 id="displayName">Loading Video...</h1>
        <video id="my-video" class="video-js vjs-default-skin" controls preload="auto" width="100%" height="auto">
            <source src="" type="application/x-mpegURL">
            <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a web browser that
                <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
            </p>
        </video>
        
        <div class="controls">
            <a href="#" id="backBtn" class="back-button"><i class="fas fa-arrow-left"></i> Back to Course</a>
            <div style="display: flex; align-items: center;">
                <div class="speed-control">
                    <label for="speedSelect">Speed:</label>
                    <select id="speedSelect">
                        <option value="0.5">0.5x</option>
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2.0">2.0x</option>
                    </select>
                </div>
                <button id="markCompleteBtn"><i class="fas fa-check"></i> Mark as Complete</button>
                <button id="favoriteBtn" class="favorite-btn"><i class="fas fa-heart"></i> Add to Fav</button>
            </div>
        </div>
        <p class="status" id="videoStatus"></p>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://unpkg.com/@videojs/http-streaming@3.7.0/dist/videojs-http-streaming.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const videoUrl = params.get('url');
            const videoName = params.get('name');
            const coursePath = params.get('path');
            const videoNum = params.get('num');
            const uniqueId = coursePath + '_V_' + videoNum; // Consistent unique ID for video

            if (!videoUrl || !videoName || !coursePath) {
                document.getElementById('displayName').textContent = 'Error: Video details missing.';
                return;
            }

            // Update UI elements
            document.getElementById('videoTitle').textContent = videoName;
            document.getElementById('displayName').textContent = videoName;
            document.getElementById('backBtn').href = coursePath;

            // --- 1. HLS Player Setup ---
            const videoElement = document.getElementById('my-video');
            videoElement.src = videoUrl;
            const player = videojs('my-video');
            
            // --- 2. Playback Speed Control ---
            const speedSelect = document.getElementById('speedSelect');
            const savedSpeed = localStorage.getItem('playbackSpeed') || '1.0';
            speedSelect.value = savedSpeed;
            player.ready(() => {
                player.playbackRate(parseFloat(savedSpeed));
            });

            speedSelect.onchange = function() {
                const newSpeed = this.value;
                player.playbackRate(parseFloat(newSpeed));
                localStorage.setItem('playbackSpeed', newSpeed);
            };

            // --- 3. Time Tracking and Resume ---
            let videoProgress = JSON.parse(localStorage.getItem('videoProgress')) || {};
            let progressInterval;
            
            player.on('loadedmetadata', function() {
                const savedTime = videoProgress[uniqueId] || 0;
                if (savedTime > 5 && player.duration() > 10) { 
                    player.currentTime(savedTime);
                    document.getElementById('videoStatus').textContent = 'Resuming from ' + Math.floor(savedTime / 60) + ' min ' + Math.floor(savedTime % 60) + ' sec...';
                } else {
                    document.getElementById('videoStatus').textContent = 'Ready to Play!';
                }

                // Start saving progress every 5 seconds
                progressInterval = setInterval(() => {
                    if (!player.paused() && !player.ended()) {
                        videoProgress[uniqueId] = player.currentTime();
                        localStorage.setItem('videoProgress', JSON.stringify(videoProgress));
                    }
                }, 5000);
            });

            // Clear interval on destroy/page unload
            window.addEventListener('beforeunload', () => {
                clearInterval(progressInterval);
                if (player) {
                    player.dispose();
                }
            });
            
            // --- 4. Mark Complete & History ---
            const completedVideos = JSON.parse(localStorage.getItem('completedVideos')) || {};
            const markCompleteBtn = document.getElementById('markCompleteBtn');

            function updateCompletionStatus() {
                if (completedVideos[uniqueId]) {
                    markCompleteBtn.innerHTML = '<i class="fas fa-undo"></i> Mark as Incomplete';
                    markCompleteBtn.style.backgroundColor = '#17a2b8';
                    document.getElementById('videoStatus').textContent = '✅ Video is marked COMPLETED.';
                } else {
                    markCompleteBtn.innerHTML = '<i class="fas fa-check"></i> Mark as Complete';
                    markCompleteBtn.style.backgroundColor = '#28a745';
                }
            }

            markCompleteBtn.onclick = function() {
                if (completedVideos[uniqueId]) {
                    delete completedVideos[uniqueId];
                    document.getElementById('videoStatus').textContent = 'Marked as INCOMPLETE.';
                } else {
                    completedVideos[uniqueId] = true;
                    document.getElementById('videoStatus').textContent = 'Marked as COMPLETED!';
                }
                localStorage.setItem('completedVideos', JSON.stringify(completedVideos));
                updateCompletionStatus();
            };

            player.on('ended', function() {
                completedVideos[uniqueId] = true;
                localStorage.setItem('completedVideos', JSON.stringify(completedVideos));
                updateCompletionStatus();
            });

            // Initial status update
            updateCompletionStatus();

            // --- 5. Favorite Button Logic ---
            const favoriteBtn = document.getElementById('favoriteBtn');
            let favorites = JSON.parse(localStorage.getItem('favorites')) || {};
            
            function updateFavoriteButton() {
                if (favorites[uniqueId]) {
                    favoriteBtn.innerHTML = '❤️ Favourited';
                    favoriteBtn.style.backgroundColor = '#dc3545';
                    favoriteBtn.style.color = 'white';
                } else {
                    favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Add to Fav';
                    favoriteBtn.style.backgroundColor = '#ffc107';
                    favoriteBtn.style.color = '#333';
                }
            }

            favoriteBtn.onclick = function() {
                if (favorites[uniqueId]) {
                    delete favorites[uniqueId];
                } else {
                    favorites[uniqueId] = { 
                        url: videoUrl, 
                        name: videoName, 
                        path: coursePath, 
                        num: videoNum,
                        type: 'video', 
                        dateAdded: new Date().toISOString().slice(0, 10) 
                    }; 
                }
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavoriteButton();
            };

            updateFavoriteButton();

            // --- 6. Study Time Tracking ---
            let lastActivityTime = new Date();
            let timeTrackingInterval = setInterval(trackStudyTime, 60000); // Check every minute

            function trackStudyTime() {
                const now = new Date();
                const diffSeconds = (now - lastActivityTime) / 1000;
                
                // Only track if video is playing/not paused and screen is focused (browser tab active)
                if (player && !player.paused() && document.visibilityState === 'visible' && diffSeconds < 70) {
                    const todayData = JSON.parse(localStorage.getItem('todayData')) || {};
                    const todayDate = now.toISOString().slice(0, 10);
                    
                    // Add 60 seconds (since we check every 60s)
                    todayData[todayDate] = (todayData[todayDate] || 0) + 60; 
                    localStorage.setItem('todayData', JSON.stringify(todayData));
                }
                lastActivityTime = now;
            }
            
            // Resume tracking if user focuses back on the window
            window.addEventListener('focus', () => {
                lastActivityTime = new Date();
                timeTrackingInterval = setInterval(trackStudyTime, 60000);
            });
            // Pause tracking if user switches tab/app
            window.addEventListener('blur', () => {
                clearInterval(timeTrackingInterval);
            });
        });
    </script>
</body>
</html>
